#!/usr/bin/env bash

cd "$(dirname "$0")" || exit

set -e

export ANSIBLE_HOME="${XDG_DATA_HOME:-$HOME/.local/share}/ansible"
export ANSIBLE_GALAXY_CACHE_DIR="$GALAXY_CACHE_DIR"
export ANSIBLE_LOCAL_TEMP="$ANSIBLE_HOME/tmp"

if [[ -f "$PWD/requirements.yml" ]]; then
    # ansible-galaxy install -r "$PWD/requirements.yml"
    true
fi

echo "ANSIBLE_HOME: $ANSIBLE_HOME"
echo "ANSIBLE_GALAXY_CACHE_DIR: $ANSIBLE_GALAXY_CACHE_DIR"
echo "ANSIBLE_LOCAL_TEMP: $ANSIBLE_LOCAL_TEMP"

run() {
    set -x
    exec ansible-playbook --extra-vars "@$PWD/values.yml" "$PWD/site.yml" "$@"
}

if test -z "$RUNNING_INSIDE_DOCKER"; then
    run --ask-become-pass "$@"
else
    run "$@"
fi
